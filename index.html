<!DOCTYPE html>
<html lang="es">
<head>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #f0f4ff;
      padding: 2rem;
      max-width: 800px;
      margin: auto;
    }
    textarea {
      width: 100%;
      height: 200px;
      margin-bottom: 1rem;
      font-family: monospace;
      padding: 1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      resize: vertical;
      background-color: #fdfdfd;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      background-color: #3366ff;
      color: white;
      border: none;
      border-radius: 8px;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #254eda;
    }
    #resultado {
      margin-top: 1rem;
      font-weight: bold;
      background: #fff;
      border: 1px solid #ccc;
      padding: 1rem;
      border-radius: 8px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <h1>Analizador de Panic Full - iPhone</h1>
  <p>Pega el texto del Panic Full abajo:</p>
  <textarea id="panicText" placeholder="Pega aquÃ­ el log del panic..."></textarea>
  <button onclick="analizarPanic()">Analizar</button>
  <button onclick="limpiar()">Limpiar</button>

  <div id="resultado"></div>

  <h2>O cargar archivo .ips</h2>
  <h2>O subir una imagen del panic</h2>
  <input type="file" accept="image/*" onchange="leerImagen(event)" />
  <input type="file" id="archivoPanic" accept=".txt,.ips" onchange="leerArchivo(event)" />

  <script>
window.addEventListener('DOMContentLoaded', function () {
  window.analizarPanic = function() {
    const archivo = document.getElementById('archivoPanic').files[0];
    if (archivo) {
      const lector = new FileReader();
      lector.onload = function(e) {
        const contenido = e.target.result;
        procesarTexto(contenido);
      };
      lector.readAsText(archivo);
    } else {
      const contenidoManual = document.getElementById('panicText').value;
      procesarTexto(contenidoManual);
    }
  };

  window.limpiar = function () {
    document.getElementById('panicText').value = "";
    const fileInput = document.getElementById('archivoPanic');
    const nuevoInput = fileInput.cloneNode(true);
    nuevoInput.id = "archivoPanic";
    nuevoInput.setAttribute("onchange", "leerArchivo(event)");
    fileInput.parentNode.replaceChild(nuevoInput, fileInput);
    document.getElementById('resultado').innerHTML = "";
    alert("Campos limpiados. Puedes comenzar un nuevo anÃ¡lisis.");
  };

  window.leerArchivo = function (event) {
    const archivo = event.target.files[0];
    if (!archivo) return;
    const lector = new FileReader();
    lector.onload = function(e) {
      procesarTexto(e.target.result);
    };
    lector.readAsText(archivo);
  };

  window.leerImagen = function (event) {
    const archivo = event.target.files[0];
    if (!archivo) return;
    const lector = new FileReader();
    lector.onload = function(e) {
      const img = new Image();
      img.onload = function () {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = img.width * 2;
        canvas.height = img.height * 2;
        ctx.filter = 'contrast(150%) grayscale(0%)';
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        Tesseract.recognize(
          canvas,
          'eng+spa',
          { logger: m => console.log(m) }
        ).then(({ data: { text } }) => {
          alert("Texto reconocido automÃ¡ticamente desde la imagen.");
          document.getElementById('panicText').value = text;
          alert("Texto reconocido. Puedes revisarlo o modificarlo antes de analizar.");
        }).catch(err => {
          alert("Error al procesar imagen con OCR: " + err);
        });
      };
      img.src = e.target.result;
    };
    lector.readAsDataURL(archivo);
  };

  function procesarTexto(textoOriginal) {
    const texto = textoOriginal.toLowerCase();
    let resultado = "No se detectÃ³ una falla clara. Revisa que el panic estÃ© completo.";
    if (texto.includes("mic1")) resultado = `ðŸŽ¤ Fallo: mic1 detectado.
ðŸ‘‰ Revisa el flex del puerto de carga. En iPhone SE 2020 tambiÃ©n podrÃ­a ser una falla de placa.`;
    else if (texto.includes("mic2")) resultado = `ðŸŽ¤ Fallo: mic2 detectado.
ðŸ‘‰ Revisa el flex del botÃ³n de encendido.`;
    else if (texto.includes("prs0")) resultado = `ðŸ§ª Fallo: prs0 detectado.
ðŸ‘‰ Revisa el flex del puerto de carga.`;
    else if (texto.includes("nand") || texto.includes("ans2")) resultado = `ðŸ’¾ Fallo: Problema con la memoria NAND.
ðŸ‘‰ El almacenamiento puede estar daÃ±ado o tener un fallo lÃ³gico.`;
    else if (texto.includes("0x800")) resultado = `ðŸ”Œ Fallo: 0x800 detectado.
ðŸ‘‰ Revisa el flex del puerto de carga.`;
    else if (texto.includes("0x1000")) resultado = `ðŸ‘ƒ Fallo: 0x1000 detectado.
ðŸ‘‰ Revisa el flex del sensor de proximidad.`;
    else if (texto.includes("0x1800")) resultado = `ðŸ“¦ Fallo: 0x1800 detectado.
ðŸ‘‰ Revisa tanto el flex del puerto de carga como el del sensor de proximidad.`;
    else if (texto.includes("0x400")) resultado = `ðŸ§© Fallo: 0x400 detectado.
ðŸ‘‰ Posible separaciÃ³n entre capas (sandwich separation).`;
    else if (texto.includes("0x400000")) resultado = `ðŸ“¡ Fallo: 0x400000 detectado.
ðŸ‘‰ Revisa el flex de carga inalÃ¡mbrica (vidrio trasero).`;
    else if (texto.includes("0x100000")) resultado = `ðŸ”Œ Fallo: 0x100000 detectado.
ðŸ‘‰ Revisa el flex del puerto de carga.`;
    else if (texto.includes("0x500000")) resultado = `ðŸ“³ Fallo: 0x500000 detectado.
ðŸ‘‰ Revisa el taptic engine, el puerto de carga o comunicaciÃ³n con la baterÃ­a.`;
    else if (texto.includes("0x200000")) resultado = `ðŸ‘ƒ Fallo: 0x200000 detectado.
ðŸ‘‰ Revisa el flex del sensor de proximidad o carga inalÃ¡mbrica en modelos recientes.`;
    else if (texto.includes("0xa1")) resultado = `ðŸ”‹ Fallo: 0xa1 detectado.
ðŸ‘‰ Revisa la baterÃ­a en modelos iPhone 15 Pro o Pro Max.`;
    else if (texto.includes("0x300000")) resultado = `ðŸ”Œ Fallo: 0x300000 detectado.
ðŸ‘‰ Revisa el flex del puerto de carga.`;
    else if (texto.includes("0x700000")) resultado = `ðŸ”„ Fallo: 0x700000 detectado.
ðŸ‘‰ Revisa tanto el flex del puerto de carga como el de carga inalÃ¡mbrica.`;

    document.getElementById('resultado').innerText = resultado;
  }
});
  </script>
</body>
</html>
